{% extends "base.html" %}
{% load static %}

{% block title %}複数画像変換進行中 - Style AI Generator{% endblock %}

{% block content %}
<!-- Overall Progress -->
<section class="loading-card" id="multiple-conversion-progress" style="max-width: 800px; margin-bottom: 3rem;">
    <h2 style="margin-bottom: 1.5rem;">画像変換を実行中...</h2>
    
    <!-- AI Spinner -->
    <div class="ai-spinner" style="width: 60px; height: 60px;">
        <div class="ai-spinner-core" style="width: 30px; height: 30px;"></div>
    </div>

    <!-- Overall Status -->
    <div class="status-text" id="overall-status-phase">準備中...</div>
    <div class="sub-status-text" id="overall-message">全ての変換が完了するまでお待ちください</div>

    <!-- Overall Progress Bar -->
    <div class="progress-bar-custom-container">
        <div class="progress-bar-custom" id="overall-progress-bar" style="width: 0%;"></div>
    </div>
    
    <div id="overall-counter" style="margin-bottom: 2rem; font-weight: 500;">0 / 0 件完了</div>

    <!-- Tips Section -->
    <div class="tips-container">
        <div class="tips-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            TIPS
        </div>
        <div class="tips-text" id="tips-text">複数の画像を並行して処理しています...</div>
    </div>
    
    <button class="btn btn-outline-danger btn-sm" id="cancel-all-conversions" type="button">
        すべての変換をキャンセル
    </button>
</section>

<!-- Individual Items -->
<div class="container" style="max-width: 1000px;">
    <h3 class="h4 mb-4 text-center">各画像の進捗</h3>
    <div class="row g-3" id="conversion-items"></div>
</div>

<!-- Template -->
<template id="conversion-item-template">
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 conversion-card border-0 shadow-sm">
            <div class="card-body">
                <h4 class="card-title conversion-title" style="font-size: 1rem; margin-bottom: 0.75rem;">変換 #1</h4>
                <p class="card-text small text-muted conversion-prompt" style="margin-bottom: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">プロンプト...</p>
                
                <div class="progress" style="height: 4px; margin-bottom: 1rem; background-color: var(--bg-tertiary);">
                    <div class="progress-bar conversion-progress-bar" role="progressbar" style="width: 0%; background-color: var(--accent-color);"></div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center small">
                    <div class="conversion-status d-flex align-items-center">
                        <span class="conversion-status-dot status-dot-pending"></span>
                        <span class="conversion-status-text text-muted">待機中</span>
                    </div>
                    <span class="conversion-counter text-muted">0 / 0</span>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
// 変換IDをURLパラメータから取得
const urlParams = new URLSearchParams(window.location.search);
const conversionIdsParam = urlParams.get('ids');
const conversionIds = conversionIdsParam ? conversionIdsParam.split(',').map(id => parseInt(id)) : [];
</script>
<script src="{% static 'js/websocket-client.js' %}"></script>
<script src="{% static 'js/progress_multiple.js' %}"></script>
{% endblock %}
