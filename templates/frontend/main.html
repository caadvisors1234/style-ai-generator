{% extends "base.html" %}
{% load static %}

{% block title %}アップロード - Style AI Generator{% endblock %}

{% block content %}
<section style="margin-bottom: 4rem;">
    <div class="d-flex align-items-center justify-content-between" style="margin-bottom: 2rem;">
        <h2 class="mb-0">画像アップロード</h2>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'frontend:gallery' %}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-images me-1"
                viewBox="0 0 16 16">
                <path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z" />
                <path
                    d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2zM14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1zM2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1h-10z" />
            </svg>
            ギャラリーを見る
        </a>
    </div>
    <div id="drop-zone" class="drop-zone" style="margin-bottom: 2rem;">
        <div class="text-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="text-muted"
                style="margin-bottom: 1.5rem;" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z" />
                <path
                    d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z" />
            </svg>
            <p class="mb-2" style="font-size: 1rem; font-weight: 500;">
                <span class="d-none d-md-inline">ここに画像をドラッグ＆ドロップ</span>
                <span class="d-md-none">ここをタップして画像を選択</span>
            </p>
            <p class="text-secondary small" style="margin-bottom: 1.5rem;">または</p>
            <button class="btn btn-primary" id="file-picker-button" type="button">ファイルを選択</button>
            <input type="file" id="file-input" accept="image/*" multiple hidden>
            <p class="text-muted small mb-0" style="margin-top: 1.5rem;">JPEG / PNG / WebP / HEIC / HEIF、最大10枚</p>
        </div>
    </div>
    <div class="card mb-3">
        <div class="card-body">
            <label class="form-label" for="hpb-url-input">HotPepper BeautyのURLから画像を取得</label>
            <div class="input-group">
                <input id="hpb-url-input" type="url" class="form-control" placeholder="スタイル、スタイリスト、ブログのURLをペースト">
                <button id="fetch-hpb-images-button" class="btn btn-outline-primary" type="button">
                    <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                    <span class="button-text">取得</span>
                </button>
            </div>
            <small class="form-text text-muted mt-2">スタイル、スタイリスト、ブログページのURLに対応しています。</small>
        </div>
    </div>
    <div id="upload-errors" class="alert alert-danger d-none"></div>
    <div id="uploaded-list" class="row g-3"></div>
</section>

<section style="margin-top: 4rem;">
    <h2 style="margin-bottom: 2rem;">変換設定</h2>
    <div style="margin-bottom: 2rem;">
        <label class="form-label">ワンタップ・プリセット（入力サポート）</label>

        <!-- 操作ボタン -->
        <div class="mb-3 d-flex gap-2 align-items-center">
            <button type="button" id="toggle-multi-select" class="btn btn-sm btn-outline-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-check2-square me-1" viewBox="0 0 16 16">
                    <path
                        d="M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8a.5.5 0 0 1 0 1H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5V8a.5.5 0 0 1 1 0v5a1.5 1.5 0 0 1-1.5 1.5H3z" />
                    <path
                        d="m8.354 10.354 7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z" />
                </svg>
                複数選択
            </button>
            <span id="multi-select-indicator" class="text-muted small" style="display: none;">
                複数選択モード：<span id="selected-count">0</span>件選択中
            </span>
        </div>

        <!-- カテゴリタブ -->
        <ul class="nav nav-tabs mb-3" id="prompt-category-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-all" data-category="all" type="button" role="tab">
                    すべて
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-favorites" data-category="favorites" type="button" role="tab">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                        class="bi bi-star-fill me-1" viewBox="0 0 16 16">
                        <path
                            d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z" />
                    </svg>
                    お気に入り
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-recent" data-category="recent" type="button" role="tab">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                        class="bi bi-clock-history me-1" viewBox="0 0 16 16">
                        <path
                            d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 0 1-.401.432l-.707-.707z" />
                        <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z" />
                        <path
                            d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z" />
                    </svg>
                    最近使用
                </button>
            </li>
            <!-- 通常カテゴリタブは動的に生成されます -->
        </ul>

        <!-- プリセットボタンコンテナ -->
        <div class="d-flex flex-wrap gap-2" id="prompt-preset-container">
            <span class="text-muted small">読み込み中...</span>
        </div>

        <!-- プリセットが見つからない場合のメッセージ -->
        <div id="prompt-no-results" class="text-muted small mt-2" style="display: none;">
            候補が見つかりませんでした
        </div>
    </div>
    <div style="margin-bottom: 2rem;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <label for="custom-prompt" class="form-label mb-0">自由入力（あなたの指示）</label>
            <button class="btn btn-link btn-sm p-0 text-decoration-none" type="button" data-bs-toggle="collapse"
                data-bs-target="#promptTips" aria-expanded="false" aria-controls="promptTips">
                <small>💡 上手なプロンプトの書き方</small>
            </button>
        </div>

        <div class="collapse mb-3" id="promptTips">
            <div class="card card-body bg-light border-0 small">
                <div class="mb-2">
                    <strong>推奨フォーマット</strong>
                    <div class="text-muted mt-1">
                        「 <strong>[①主語]</strong> ＋ <strong>[②状況・動作]</strong> ＋ <strong>[③スタイル・照明]</strong> 」
                    </div>
                </div>
                <div class="row text-muted mb-2">
                    <div class="col-md-4">
                        <span class="fw-bold">①主語</span>：髪型、髪色、特徴（例：「ミディアムヘアの女性、アッシュブラウン」）
                    </div>
                    <div class="col-md-4">
                        <span class="fw-bold">②状況</span>：場所、表情（例：「自然光のカフェ、笑顔」）
                    </div>
                    <div class="col-md-4">
                        <span class="fw-bold">③スタイル</span>：雰囲気、画角（例：「ふんわり、逆光、クローズアップ」）
                    </div>
                </div>
                <div>
                    <strong>コツ:</strong>
                    <span
                        class="text-muted">単語の羅列ではなく<strong>自然な文章</strong>で、「〜しないで」ではなく「<strong>〜がある</strong>」と肯定的に書くと伝わりやすいです。</span>
                </div>
            </div>
        </div>

        <div class="position-relative">
            <textarea id="custom-prompt" class="form-control" rows="4" placeholder="仕上がりイメージや要望を具体的に記述してください"
                style="padding-bottom: 3rem;"></textarea>
            <div class="position-absolute bottom-0 end-0 p-2">
                <button id="improve-prompt-btn" type="button" class="btn btn-sm btn-outline-primary"
                    style="border-radius: 8px; padding: 0.375rem 0.75rem; font-size: 0.875rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                        class="bi bi-magic me-1" viewBox="0 0 16 16">
                        <path
                            d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707ZM7.293 4A.5.5 0 1 0 8 3.293L6.707 2A.5.5 0 0 0 6 2.707L7.293 4Zm-.621 2.5a.5.5 0 1 0 0-1H4.843a.5.5 0 1 0 0 1h1.829Zm8.485 0a.5.5 0 1 0 0-1h-1.829a.5.5 0 0 0 0 1h1.829ZM13.293 10A.5.5 0 1 0 14 9.293L12.707 8a.5.5 0 1 0-.707.707L13.293 10ZM9.5 11.157a.5.5 0 0 0 1 0V9.328a.5.5 0 0 0-1 0v1.829Zm1.854-5.097a.5.5 0 0 0 0-.706l-.708-.708a.5.5 0 0 0-.707 0L8.646 5.94a.5.5 0 0 0 0 .707l.708.708a.5.5 0 0 0 .707 0l1.293-1.293Zm-3 3a.5.5 0 0 0 0-.706l-.708-.708a.5.5 0 0 0-.707 0L.646 13.94a.5.5 0 0 0 0 .707l.708.708a.5.5 0 0 0 .707 0L8.354 9.06Z" />
                    </svg>
                    <span class="improve-btn-text">AIで改善</span>
                    <span class="spinner-border spinner-border-sm d-none ms-1" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
    <!-- Configuration Options (Accordion) -->
    <div class="sheet-overlay" id="sheet-overlay"></div>

    <button class="btn btn-light d-md-none shadow position-fixed" id="mobile-settings-btn" type="button"
        style="bottom: 1.5rem; left: 1.5rem; z-index: 1050; border-radius: 50px; padding: 1rem 1.5rem; border: 1px solid var(--border-color);">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sliders"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3h9.05zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8h2.05zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 13a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1h9.05z" />
        </svg>
        設定
    </button>

    <div id="generation-options-container">
        <div class="accordion mb-3 shadow-sm rounded" id="settingsAccordion">
            <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingSettings">
                    <button class="accordion-button collapsed fw-medium" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseSettings" aria-expanded="false" aria-controls="collapseSettings">
                        生成オプション（枚数・モデル・比率）
                    </button>
                </h2>
                <div id="collapseSettings" class="accordion-collapse collapse" aria-labelledby="headingSettings"
                    data-bs-parent="#settingsAccordion">
                    <div class="accordion-body bg-white">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="generation-count" class="form-label">生成枚数（画像数）</label>
                                <select id="generation-count" class="form-select">
                                    <option value="1" selected>1枚</option>
                                    <option value="2">2枚</option>
                                    <option value="3">3枚</option>
                                    <option value="4">4枚</option>
                                    <option value="5">5枚</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <span class="form-label d-block mb-2">モデル選択（クレジット）</span>
                                <div class="row g-2" id="model-variant-group">
                                    <div class="col-12">
                                        <label class="model-option w-100">
                                            <input type="radio" name="model_variant" value="gemini-2.5-flash-image"
                                                class="form-check-input" checked>
                                            <div class="model-option-body">
                                                <div class="fw-semibold">Gemini 2.5 Flash Image</div>
                                                <div class="text-muted small">速い・低コスト / 日常利用向け（1クレジット/画像）</div>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="col-12">
                                        <label class="model-option w-100">
                                            <input type="radio" name="model_variant" value="gemini-3-pro-image-preview"
                                                class="form-check-input">
                                            <div class="model-option-body">
                                                <div class="fw-semibold">Gemini 3 Pro Image Preview</div>
                                                <div class="text-muted small">高品質・高コスト / 厳選出力向け（5クレジット/画像）</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="aspect-ratio" class="form-label">画像比率</label>
                                <select id="aspect-ratio" class="form-select">
                                    <option value="original" selected>そのまま（元画像を維持）</option>
                                    <option value="1:1">1:1（スクエア）</option>
                                    <option value="3:4">3:4（ポートレート）</option>
                                    <option value="4:3">4:3（標準）</option>
                                    <option value="9:16">9:16（縦長）</option>
                                    <option value="16:9">16:9（ワイド）</option>
                                    <option value="3:2">3:2</option>
                                    <option value="2:3">2:3</option>
                                    <option value="21:9">21:9（シネマ）</option>
                                    <option value="9:21">9:21</option>
                                    <option value="4:5">4:5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
        <div class="text-muted small" id="estimated-credit">この条件で合計 0 クレジット</div>
        <button class="btn btn-primary btn-lg" id="start-conversion" type="button" disabled
            style="padding: 0.75rem 2rem;">
            変換を開始
        </button>
    </div>
</section>
</div>
</div>

<template id="uploaded-item-template">
    <div class="col-6 col-sm-4 col-md-3 col-lg-5th">
        <div class="card h-100">
            <img src="" class="card-img-top uploaded-thumb" alt="">
            <div class="card-body">
                <h5 class="card-title small uploaded-name"></h5>
                <p class="card-text text-muted small uploaded-size"></p>
                <button class="btn btn-sm btn-outline-danger w-100 remove-upload" type="button">削除</button>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/prompts.js' %}"></script>
<script src="{% static 'js/prompt-improver.js' %}"></script>
<script src="{% static 'js/upload.js' %}"></script>
<script src="{% static 'js/convert.js' %}"></script>
{% endblock %}